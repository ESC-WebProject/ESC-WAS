<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로그인</title>
</head>
<body>
<h2>로그인 페이지</h2>
<form id="loginForm">
    <label for="username">아이디:</label>
    <input type="number" id="username" name="username" required>
    <br>
    <label for="password">비밀번호:</label>
    <input type="password" id="password" name="password" required>
    <br>
    <button type="submit">로그인</button>
</form>

<p id="message"></p>
<div id="jwtContainer" style="display: none;">
    <h3>JWT 토큰:</h3>
    <textarea id="jwtToken" rows="5" cols="50" readonly></textarea>
    <br>
    <button onclick="copyToken()">📋 복사</button>
</div>

<script>
    document.getElementById("loginForm").addEventListener("submit", async function(event) {
        event.preventDefault(); // 폼 기본 제출 동작 막기

        const studentId = Number(document.getElementById("username").value);
        const pwd = document.getElementById("password").value;

        console.log("🔹 전송 데이터:", { studentId, pwd });

        const response = await fetch("/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ studentId, pwd })
        });

        const messageEl = document.getElementById("message");
        const jwtContainer = document.getElementById("jwtContainer");
        const jwtTokenField = document.getElementById("jwtToken");

        const data = await response.json();  // 🔹 JSON 응답 받기
        console.log("🔹 서버 응답:", data); // 🔥 JSON 구조 확인용 로그

        if (response.ok) {
            const token = data.jwt; // `{ "jwt": "토큰값" }` 형식

            if (!token) {
                messageEl.textContent = "❌ 로그인 성공했지만, 토큰을 받지 못했습니다.";
                messageEl.style.color = "orange";
                return;
            }

            // 🔥 JWT를 쿠키에 저장 (유효시간: 1시간)
            document.cookie = `jwtToken=${token}; path=/; max-age=3600; secure`;

            messageEl.textContent = "✅ 로그인 성공! 3초 후 메인 페이지로 이동합니다...";
            messageEl.style.color = "green";

            // JWT 토큰 표시
            jwtTokenField.value = token;
            jwtContainer.style.display = "block";

            // 🔥 3초 후 `index.html`로 이동
            setTimeout(() => {
                window.location.href = "/index.html";
            }, 3000);
        } else {
            messageEl.textContent = "❌ 로그인 실패! 아이디 또는 비밀번호 확인";
            messageEl.style.color = "red";
            jwtContainer.style.display = "none";
        }
    });

    // 📋 JWT 복사 기능
    function copyToken() {
        const jwtTokenField = document.getElementById("jwtToken");
        jwtTokenField.select();
        document.execCommand("copy");
        alert("JWT 토큰이 복사되었습니다! 📋");
    }
</script>

</body>
</html>
